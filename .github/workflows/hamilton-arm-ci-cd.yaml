name: Build Hamilton Medical Image

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Manual trigger
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM (regular safety builds)

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        platforms: linux/arm64  # Raspberry Pi architecture

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata (tags, labels)
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        # Hier fügen wir die "lowercase" Option hinzu:
        flavor: |
          latest=auto
        tags: |
          type=ref,event=branch
          type=sha,prefix=,format=short
          type=raw,value=latest-arm,enable=${{ github.ref == format('refs/heads/{0}', github.event.repository.default_branch) }}
          type=raw,value=nightly,enable=${{ github.event_name == 'schedule' }}

    - name: Build and push Hamilton Medical image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: Dockerfile.hamilton-arm
        platforms: linux/arm64
        push: ${{ github.event_name != 'pull_request' }}
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Generate build report
      if: success()
      run: |
        echo "=== HAMILTON MEDICAL BUILD REPORT ==="
        echo "Repository: ${{ github.repository }}"
        echo "Build ID: ${{ github.run_id }}"
        echo "Commit: ${{ github.sha }}"
        echo "Platform: ARM64 (Raspberry Pi)"
        echo "Tags: ${{ steps.meta.outputs.tags }}"
        echo ""
        echo "Image available at:"
        echo "  ghcr.io/${{ github.repository }}:latest-arm"
        echo ""
        echo "To deploy on Raspberry Pi K3s:"
        echo "  kubectl set image deployment/hamilton-medical \\"
        echo "    *=ghcr.io/${{ github.repository }}:latest-arm"

    - name: Notify on failure
      if: failure()
      run: |
        echo "❌ Hamilton Medical build failed!"
        echo "Check logs for details."

  security-scan:
    needs: build-and-push
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
        
    # DIESER SCHRITT FEHLT: Einloggen, damit Trivy das Image ziehen kann
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest-arm
          #image-ref: 'ghcr.io/benmclemor/hamilton:latest-arm'
        format: 'sarif'
        output: 'trivy-results.sarif'
        platform: 'linux/arm64'
      env:
        # Trivy braucht oft diesen Trick, um mit Großbuchstaben in Repos umzugehen:
        TRIVY_USERNAME: ${{ github.actor }}
        TRIVY_PASSWORD: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Upload Trivy scan results
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: 'trivy-results.sarif'
        
    - name: Security report
      run: |
        echo "=== MEDICAL DEVICE SECURITY SCAN ==="
        echo "Image scanned: ghcr.io/${{ github.repository }}:latest-arm"
        echo "Security scanning complete for medical device compliance"
